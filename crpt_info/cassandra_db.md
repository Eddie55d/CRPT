## Компакшен (сжатие) в Cassandra 
Это процесс, который объединяет SSTable-файлы и удаляет устаревшие данные. Если скорость компакшена не ограничена, это может привести к высокой нагрузке на систему, особенно если компакшен выполняется слишком часто или слишком быстро. Вопрос может подразумевать, что необходимо проверить настройки компакшена, чтобы убедиться, что он не вызывает проблем с производительностью.

---

## Cпекулятивный ретрай (speculative retry) 
Это механизм в Cassandra, который позволяет повторно отправлять запросы на другие узлы, если ответ от основного узла задерживается. Если спекулятивный ретрай не включен для таблицы эмиссии, это может привести к увеличению времени ожидания для запросов, особенно если основной узел перегружен или недоступен. Вопрос может подразумевать, что стоит рассмотреть возможность включения спекулятивного ретрая для улучшения производительности и уменьшения задержек.

---

## Repair
**Repair в Apache Cassandra** — это процесс, который используется для синхронизации данных между узлами в кластере. Он необходим для обеспечения целостности данных и устранения возможных несоответствий, которые могут возникнуть из-за различных факторов, таких как:

- Сетевые сбои
- Выход узлов из строя
- Ошибки записи или чтения
- Различия в данных между репликами  

**Зачем нужен Repair?**  
- Обеспечение целостности данных: Repair помогает гарантировать, что все узлы в кластере имеют одинаковые данные, что критически важно для распределенных систем.

- Устранение несоответствий: В процессе работы кластера могут возникать несоответствия данных между репликами. Repair помогает выявить и устранить эти несоответствия.

- Поддержка механизма консистентности: Cassandra использует механизм репликации, и Repair помогает поддерживать консистентность данных между репликами.

- Устранение устаревших данных: Repair также может помочь удалить устаревшие или неактуальные данные, которые могут остаться после операций удаления (tombstones).

**Проблемы, которые могут возникнуть:**  
Несоответствия данных: Если данные на разных узлах не совпадают, это может привести к ошибкам при чтении.  
Проблемы с производительностью: Частые операции Repair могут негативно сказаться на производительности кластера, особенно если они выполняются в рабочее время.  
Увеличение времени выполнения: Repair может занять значительное время, особенно в больших кластерах с большим объемом данных.

--- 

## "Full Repair"  
Это операция, которая используется для синхронизации данных между узлами в кластере Cassandra, чтобы гарантировать, что все реплики имеют одинаковые данные. Full Repair важен для поддержания целостности данных и устранения несоответствий, которые могут возникнуть из-за различных факторов, таких как сбои узлов, сетевые проблемы или ошибки записи.

- Зачем нужен Full Repair (FR)?
Синхронизация данных: В распределенных системах, таких как Cassandra, данные могут быть записаны на разные узлы. Full Repair помогает убедиться, что все узлы имеют одинаковые данные.

- Устранение несоответствий: Если данные на разных узлах не совпадают, это может привести к ошибкам при чтении. Full Repair помогает выявить и устранить эти несоответствия.

- Поддержка механизма консистентности: Cassandra использует механизм репликации, и Full Repair помогает поддерживать консистентность данных между репликами.

- Удаление устаревших данных: Full Repair также может помочь удалить устаревшие или неактуальные данные, которые могут остаться после операций удаления (tombstones).


Для выполнения Full Repair в Cassandra используется команда nodetool repair.
Эта команда выполнит Full Repair для всех ключевых пространств на узле, на котором она была запущена. 


```sh
nodetool repair
```


Вы также можете указать конкретное ключевое пространство:

```sh
nodetool repair <keyspace_name>
```

**Важные моменты**
- Производительность: Full Repair может быть ресурсоемким процессом, особенно в больших кластерах с большим объемом данных. Рекомендуется выполнять его в период низкой нагрузки.

- Частота выполнения: Рекомендуется выполнять Full Repair регулярно, чтобы поддерживать целостность данных. Частота выполнения зависит от объема данных и активности кластера.

- Мониторинг: После выполнения полного ремонта полезно проверить состояние узлов и метрики, чтобы убедиться, что операция прошла успешно и не вызвала проблем с производительностью.

Full Repair (FR) в Cassandra — это важная операция для поддержания целостности и консистентности данных в распределенной системе. Понимание его назначения и правильное выполнение помогут вам эффективно управлять кластером Cassandra и предотвращать проблемы с данными.

---

## Запуск CQLSH (Cassandra Query Language Shell):

```sh
cqlsh
```

## Repair:

Для выполнения операции Repair на определенном ключевом пространстве:

```sh
nodetool repair <keyspace_name>
```

Для выполнения Repair на всех ключевых пространствах:

```sh
nodetool repair
```

```sh
cqlsh> DESCRIBE KEYSPACES;
```

Просмотр информации о таблицах:

```sh
cqlsh> DESCRIBE TABLES;
```

Удаление устаревших данных:

Для удаления устаревших данных (tombstones):

```sh
nodetool compact <keyspace_name> <table_name>
```

---

## Проверка операций компакшена
Проверьте, выполняется ли компакшен:


```sh
nodetool compactionstats
```
Эта команда покажет, какие таблицы находятся в процессе компакшена и сколько данных будет обработано

---

## Проверьте размер данных Cassandra:

Данные Cassandra хранятся в каталоге данных, который обычно находится по пути /var/lib/cassandra/data. Вы можете проверить размер этого каталога:

```sh
du -sh /var/lib/cassandra/data
```
Это покажет общий размер данных, хранящихся в Cassandra.

---



## Просмотр логов Cassandra

Логи Cassandra обычно находятся в каталоге /var/log/cassandra/ или в каталоге, указанном в конфигурации logback.xml.   
Основной лог-файл называется system.log.

Чтобы просмотреть лог-файл, используйте команду less:

```sh
less /var/log/cassandra/system.log
```

## 2. Фильтрация логов:

```sh
grep "ERROR" /var/log/cassandra/system.log
```

Чтобы игнорировать регистр:

```sh
grep -i "error" /var/log/cassandra/system.log
```

**Фильтрация по времени**

```sh
awk '/2023-10-01/' /var/log/cassandra/system.log
```

Если вы хотите фильтровать по диапазону дат, вы можете использовать awk с более сложными условиями:

```sh
awk '$0 >= "2025-01-01" && $0 <= "2025-01-31"' /var/log/cassandra/system.log
```

## 3. Форматирование вывода

Использование less с подсветкой
Вы можете использовать less с подсветкой для улучшения читаемости:

```sh
grep "ERROR" /var/log/cassandra/system.log | less -R
```

Использование cat с grep и less
Если вы хотите просмотреть логи с подсветкой и прокруткой, вы можете использовать следующую команду:

```sh
cat /var/log/cassandra/system.log | grep --color=auto "ERROR" | less
```

## 4. Использование tail для просмотра последних записей:

Чтобы просмотреть последние 100 строк лога:

```sh
tail -n 100 /var/log/cassandra/system.log
```

Чтобы следить за изменениями в реальном времени:

```sh
tail -f /var/log/cassandra/system.log
```

## 5. Использование journalctl для системных логов:


Просмотр логов Cassandra:

```sh
journalctl -u cassandra
```

Фильтрация по времени:

```sh
journalctl --since "2023-10-01" --until "2023-10-31"
```

Следить за логами в реальном времени:
```sh
journalctl -u cassandra -f
```

## 6. Использование awk для более сложного анализа:
awk позволяет выполнять более сложные операции с логами. Например, чтобы подсчитать количество ошибок:

```sh
awk '/ERROR/ {count++} END {print count}' /var/log/cassandra/system.log
```


---

## Проверка логов

Логи Cassandra могут содержать информацию о том, что происходит с узлом. Логи обычно находятся в /var/log/cassandra/system.log. Вы можете просмотреть последние записи в логах:

```sh
tail -f /var/log/cassandra/system.log
```
Это поможет вам увидеть, если узел находится в процессе восстановления, компакшена или других операций.

---

## Проверьте состояние узлов:

Вы также можете использовать команду nodetool для получения информации о состоянии узлов:

```sh
nodetool status
```
Эта команда покажет статус каждого узла в кластере (например, UN для "Up and Normal", DN для "Down and Normal", LEAVING, JOINING и т.д.).

---

## nodetool describecluster
Описание: Показывает информацию о кластере, включая его имя и количество узлов.

```sh
nodetool describecluster
```

---

## nodetool info
Описание: Предоставляет информацию о конкретном узле, включая его IP-адрес, статус, количество SSTable и использование памяти.

```sh
nodetool info
```

---

## Общие команды для диагностики

### dmesg
Описание: Показывает сообщения ядра, которые могут содержать информацию о проблемах с оборудованием.
Вы можете использовать -T, чтобы преобразовать временные метки в читаемый формат.

```sh
dmesg -T | less
```
